(function(b){function C(){return b("<div/>")}var D=Math.abs,n=Math.max,p=Math.min,g=Math.round;b.imgAreaSelect=function(A,d){function P(a){return a+B.left-x.left}function Q(a){return a+B.top-x.top}function K(a){return a-B.left+x.left}function L(a){return a-B.top+x.top}function H(a){var d=a||V;a=a||W;return{x1:g(c.x1*d),y1:g(c.y1*a),x2:g(c.x2*d),y2:g(c.y2*a),width:g(c.x2*d)-g(c.x1*d),height:g(c.y2*a)-g(c.y1*a)}}function ja(a,d,b,f,e){var h=e||V;e=e||W;c={x1:g(a/h||0),y1:g(d/e||0),x2:g(b/h||0),y2:g(f/
e||0)};c.width=c.x2-c.x1;c.height=c.y2-c.y1}function N(){ba&&y.width()&&(B={left:g(y.offset().left),top:g(y.offset().top)},z=y.innerWidth(),v=y.innerHeight(),B.top+=y.outerHeight()-v>>1,B.left+=y.outerWidth()-z>>1,X=g(d.minWidth/V)||0,Y=g(d.minHeight/W)||0,ka=g(p(d.maxWidth/V||16777216,z)),la=g(p(d.maxHeight/W||16777216,v)),"1.3.2"!=b().jquery||"fixed"!=ca||ma.getBoundingClientRect||(B.top+=n(document.body.scrollTop,ma.scrollTop),B.left+=n(document.body.scrollLeft,ma.scrollLeft)),x=/absolute|relative/.test(R.css("position"))?
{left:g(R.offset().left)-R.scrollLeft(),top:g(R.offset().top)-R.scrollTop()}:"fixed"==ca?{left:b(document).scrollLeft(),top:b(document).scrollTop()}:{left:0,top:0},q=P(0),r=Q(0),(c.x2>z||c.y2>v)&&da())}function ea(a){if(fa){l.css({left:P(c.x1),top:Q(c.y1)}).add(S).width(F=c.width).height(M=c.height);S.add(u).add(t).css({left:0,top:0});u.width(n(F-u.outerWidth()+u.innerWidth(),0)).height(n(M-u.outerHeight()+u.innerHeight(),0));b(m[0]).css({left:q,top:r,width:c.x1,height:v});b(m[1]).css({left:q+c.x1,
top:r,width:F,height:c.y1});b(m[2]).css({left:q+c.x2,top:r,width:z-c.x2,height:v});b(m[3]).css({left:q+c.x1,top:r+c.y2,width:F,height:v-c.y2});F-=t.outerWidth();M-=t.outerHeight();switch(t.length){case 8:b(t[4]).css({left:F>>1}),b(t[5]).css({left:F,top:M>>1}),b(t[6]).css({left:F>>1,top:M}),b(t[7]).css({top:M>>1});case 4:t.slice(1,3).css({left:F}),t.slice(2,4).css({top:M})}if(!1!==a&&(b.imgAreaSelect.onKeyPress!=va&&b(document).unbind(b.imgAreaSelect.keyPress,b.imgAreaSelect.onKeyPress),d.keys))b(document)[b.imgAreaSelect.keyPress](b.imgAreaSelect.onKeyPress=
va);T&&2==u.outerWidth()-u.innerWidth()&&(u.css("margin",0),setTimeout(function(){u.css("margin","auto")},0))}}function na(a){N();ea(a);f=P(c.x1);e=Q(c.y1);h=P(c.x2);k=Q(c.y2)}function oa(a,b){d.fadeSpeed?a.fadeOut(d.fadeSpeed,b):a.hide()}function O(a){var b=K(a.pageX-x.left)-c.x1;a=L(a.pageY-x.top)-c.y1;pa||(N(),pa=!0,l.one("mouseout",function(){pa=!1}));w="";d.resizable&&(a<=d.resizeMargin?w="n":a>=c.height-d.resizeMargin&&(w="s"),b<=d.resizeMargin?w+="w":b>=c.width-d.resizeMargin&&(w+="e"));l.css("cursor",
w?w+"-resize":d.movable?"move":"");ga&&ga.toggle()}function wa(a){b("body").css("cursor","");(d.autoHide||0==c.width*c.height)&&oa(l.add(m),function(){b(this).hide()});b(document).unbind("mousemove",qa);l.mousemove(O);d.onSelectEnd(A,H())}function xa(a){if(1!=a.which)return!1;N();w?(b("body").css("cursor",w+"-resize"),f=P(c[/w/.test(w)?"x2":"x1"]),e=Q(c[/n/.test(w)?"y2":"y1"]),b(document).mousemove(qa).one("mouseup",wa),l.unbind("mousemove",O)):d.movable?(ra=q+c.x1-(a.pageX-x.left),sa=r+c.y1-(a.pageY-
x.top),l.unbind("mousemove",O),b(document).mousemove(ya).one("mouseup",function(){d.onSelectEnd(A,H());b(document).unbind("mousemove",ya);l.mousemove(O)})):y.mousedown(a);return!1}function Z(a){I&&(a?(h=n(q,p(q+z,f+D(k-e)*I*(h>f||-1))),k=g(n(r,p(r+v,e+D(h-f)/I*(k>e||-1)))),h=g(h)):(k=n(r,p(r+v,e+D(h-f)/I*(k>e||-1))),h=g(n(q,p(q+z,f+D(k-e)*I*(h>f||-1)))),k=g(k)))}function da(){f=p(f,q+z);e=p(e,r+v);D(h-f)<X&&(h=f-X*(h<f||-1),h<q?f=q+X:h>q+z&&(f=q+z-X));D(k-e)<Y&&(k=e-Y*(k<e||-1),k<r?e=r+Y:k>r+v&&(e=
r+v-Y));h=n(q,p(h,q+z));k=n(r,p(k,r+v));Z(D(h-f)<D(k-e)*I);D(h-f)>ka&&(h=f-ka*(h<f||-1),Z());D(k-e)>la&&(k=e-la*(k<e||-1),Z(!0));c={x1:K(p(f,h)),x2:K(n(f,h)),y1:L(p(e,k)),y2:L(n(e,k)),width:D(h-f),height:D(k-e)};ea();d.onSelectChange(A,H())}function qa(a){h=/w|e|^$/.test(w)||I?a.pageX-x.left:P(c.x2);k=/n|s|^$/.test(w)||I?a.pageY-x.top:Q(c.y2);da();return!1}function aa(a,g){h=(f=a)+c.width;k=(e=g)+c.height;b.extend(c,{x1:K(f),y1:L(e),x2:K(h),y2:L(k)});ea();d.onSelectChange(A,H())}function ya(a){f=
n(q,p(ra+(a.pageX-x.left),q+z-c.width));e=n(r,p(sa+(a.pageY-x.top),r+v-c.height));aa(f,e);a.preventDefault();return!1}function ta(){b(document).unbind("mousemove",ta);N();h=f;k=e;da();w="";m.is(":visible")||l.add(m).hide().fadeIn(d.fadeSpeed||0);fa=!0;b(document).unbind("mouseup",ha).mousemove(qa).one("mouseup",wa);l.unbind("mousemove",O);d.onSelectStart(A,H())}function ha(){b(document).unbind("mousemove",ta).unbind("mouseup",ha);oa(l.add(m));ja(K(f),L(e),K(f),L(e));this instanceof b.imgAreaSelect||
(d.onSelectChange(A,H()),d.onSelectEnd(A,H()))}function za(a){if(1!=a.which||m.is(":animated"))return!1;N();ra=f=a.pageX-x.left;sa=e=a.pageY-x.top;b(document).mousemove(ta).mouseup(ha);return!1}function Aa(){na(!1)}function Ba(){ba=!0;ua(d=b.extend({classPrefix:"imgareaselect",movable:!0,parent:"body",resizable:!0,resizeMargin:10,onInit:function(){},onSelectStart:function(){},onSelectChange:function(){},onSelectEnd:function(){}},d));l.add(m).css({visibility:""});d.show&&(fa=!0,N(),ea(),l.add(m).hide().fadeIn(d.fadeSpeed||
0));setTimeout(function(){d.onInit(A,H())},0)}function ia(a,b){for(var c in b)void 0!==d[c]&&a.css(b[c],d[c])}function ua(a){a.parent&&(R=b(a.parent)).append(l.add(m));b.extend(d,a);N();if(null!=a.handles){t.remove();t=b([]);for(U=a.handles?"corners"==a.handles?4:8:0;U--;)t=t.add(C());t.addClass(d.classPrefix+"-handle").css({position:"absolute",fontSize:0,zIndex:J+1||1});0<=!parseInt(t.css("width"))&&t.width(5).height(5);(G=d.borderWidth)&&t.css({borderWidth:G,borderStyle:"solid"});ia(t,{borderColor1:"border-color",
borderColor2:"background-color",borderOpacity:"opacity"})}V=d.imageWidth/z||1;W=d.imageHeight/v||1;null!=a.x1&&(ja(a.x1,a.y1,a.x2,a.y2),a.show=!a.hide);a.keys&&(d.keys=b.extend({shift:1,ctrl:"resize"},a.keys));m.addClass(d.classPrefix+"-outer");S.addClass(d.classPrefix+"-selection");for(U=0;4>U++;)b(u[U-1]).addClass(d.classPrefix+"-border"+U);ia(S,{selectionColor:"background-color",selectionOpacity:"opacity"});ia(u,{borderOpacity:"opacity",borderWidth:"border-width"});ia(m,{outerColor:"background-color",
outerOpacity:"opacity"});(G=d.borderColor1)&&b(u[0]).css({borderStyle:"solid",borderColor:G});(G=d.borderColor2)&&b(u[1]).css({borderStyle:"dashed",borderColor:G});l.append(S.add(u).add(ga)).append(t);T&&((G=(m.css("filter")||"").match(/opacity=(\d+)/))&&m.css("opacity",G[1]/100),(G=(u.css("filter")||"").match(/opacity=(\d+)/))&&u.css("opacity",G[1]/100));a.hide?oa(l.add(m)):a.show&&ba&&(fa=!0,l.add(m).fadeIn(d.fadeSpeed||0),na());I=(Ca=(d.aspectRatio||"").split(/:/))[0]/Ca[1];y.add(m).unbind("mousedown",
za);if(d.disable||!1===d.enable)l.unbind("mousemove",O).unbind("mousedown",xa),b(window).unbind("resize",Aa);else{if(d.enable||!1===d.disable)(d.resizable||d.movable)&&l.mousemove(O).mousedown(xa),b(window).resize(Aa);d.persistent||y.add(m).mousedown(za)}d.enable=d.disable=void 0}var y=b(A),ba,l=C(),S=C(),u=C().add(C()).add(C()).add(C()),m=C().add(C()).add(C()).add(C()),t=b([]),ga,q,r,B={left:0,top:0},z,v,R,x={left:0,top:0},J=0,ca="absolute",ra,sa,V,W,w,X,Y,ka,la,I,fa,f,e,h,k,c={x1:0,y1:0,x2:0,y2:0,
width:0,height:0},ma=document.documentElement,E=navigator.userAgent,Ca,U,G,F,M,pa,va=function(a){var b=d.keys,c,g=a.keyCode;c=isNaN(b.alt)||!a.altKey&&!a.originalEvent.altKey?!isNaN(b.ctrl)&&a.ctrlKey?b.ctrl:!isNaN(b.shift)&&a.shiftKey?b.shift:isNaN(b.arrows)?10:b.arrows:b.alt;if("resize"==b.arrows||"resize"==b.shift&&a.shiftKey||"resize"==b.ctrl&&a.ctrlKey||"resize"==b.alt&&(a.altKey||a.originalEvent.altKey)){switch(g){case 37:c=-c;case 39:a=n(f,h);f=p(f,h);h=n(a+c,f);Z();break;case 38:c=-c;case 40:a=
n(e,k);e=p(e,k);k=n(a+c,e);Z(!0);break;default:return}da()}else switch(f=p(f,h),e=p(e,k),g){case 37:aa(n(f-c,q),e);break;case 38:aa(f,n(e-c,r));break;case 39:aa(f+p(c,z-K(h)),e);break;case 40:aa(f,e+p(c,v-L(k)));break;default:return}return!1};this.remove=function(){ua({disable:!0});l.add(m).remove()};this.getOptions=function(){return d};this.setOptions=ua;this.getSelection=H;this.setSelection=ja;this.cancelSelection=ha;this.update=na;for(var T=(/msie ([\w.]+)/i.exec(E)||[])[1],Da=/opera/i.test(E),
Ea=/webkit/i.test(E)&&!/chrome/i.test(E),E=y;E.length;)J=n(J,isNaN(E.css("z-index"))?J:E.css("z-index")),"fixed"==E.css("position")&&(ca="fixed"),E=E.parent(":not(body)");J=d.zIndex||J;T&&y.attr("unselectable","on");b.imgAreaSelect.keyPress=T||Ea?"keydown":"keypress";Da&&(ga=C().css({width:"100%",height:"100%",position:"absolute",zIndex:J+2||2}));l.add(m).css({visibility:"hidden",position:ca,overflow:"hidden",zIndex:J||"0"});l.css({zIndex:J+2||2});S.add(u).css({position:"absolute",fontSize:0});A.complete||
"complete"==A.readyState||!y.is("img")?Ba():y.one("load",Ba);!ba&&T&&7<=T&&(A.src=A.src)};b.fn.imgAreaSelect=function(g){g=g||{};this.each(function(){b(this).data("imgAreaSelect")?g.remove?(b(this).data("imgAreaSelect").remove(),b(this).removeData("imgAreaSelect")):b(this).data("imgAreaSelect").setOptions(g):g.remove||(void 0===g.enable&&void 0===g.disable&&(g.enable=!0),b(this).data("imgAreaSelect",new b.imgAreaSelect(this,g)))});return g.instance?b(this).data("imgAreaSelect"):this}})(jQuery);